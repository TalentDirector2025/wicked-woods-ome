name: Run CI tool to validate schedule

on:
  push:
    branches:
      - main
      - linter

jobs:
  deploy:
    strategy:
      matrix:
        swift: [ '6.1' ]
    runs-on: ubuntu-latest
    container: swift:${{ matrix.swift }}

    env:
      REPO: ometools/open-music-event
      BINARY_NAME: open-music-event
      AWS_REGION: us-west-2

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y curl jq

      - name: Get latest release tag
        id: get_release
        run: |
          TAG=$(curl -s "https://api.github.com/repos/${REPO}/releases/latest" | jq -r .tag_name)
          echo "Latest release tag is $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Download CLI binary from latest release
        run: |
          TAG=${{ steps.get_release.outputs.tag }}
          DOWNLOAD_URL="https://github.com/${REPO}/releases/download/${TAG}/${BINARY_NAME}"

          echo "Downloading $BINARY_NAME from $DOWNLOAD_URL"
          curl -sL "$DOWNLOAD_URL" -o "$BINARY_NAME"
          chmod +x "$BINARY_NAME"

      - name: Unzip
        run: |
          unzip $BINARY_NAME
          chmod +x open-music-event

      - name: Run CLI tool
        run: |
          ./${BINARY_NAME} validate ./2024/wicked-woods-ome